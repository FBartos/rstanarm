<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Rstanarm Developer Notes</title>
  <meta name="description" content="Rstanarm Developer Notes">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="Rstanarm Developer Notes" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://mc-stan.org/rstanarm/index.html" />
  <meta property="og:image" content="https://mc-stan.org/rstanarm/index.htmlimages/logo.png" />
  
  <meta name="github-repo" content="stan-dev/rstanarm" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Rstanarm Developer Notes" />
  
  
  <meta name="twitter:image" content="https://mc-stan.org/rstanarm/index.htmlimages/logo.png" />

<meta name="author" content="Stan Development Team">


<meta name="date" content="2017-06-16">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  <link rel="shortcut icon" href="images/logo-icon.png" type="image/x-icon">
<link rel="prev" href="rstanreg-r.html">
<link rel="next" href="documentation-and-examples.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />










<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Rstanarm Developer Notes</a></li>
<li class="chapter" data-level="1" data-path="model-fitting.html"><a href="model-fitting.html"><i class="fa fa-check"></i><b>1</b> Model Fitting</a><ul>
<li class="chapter" data-level="1.1" data-path="model-fitting.html"><a href="model-fitting.html#r-stuff"><i class="fa fa-check"></i><b>1.1</b> R Stuff</a><ul>
<li class="chapter" data-level="1.1.1" data-path="model-fitting.html"><a href="model-fitting.html#tips"><i class="fa fa-check"></i><b>1.1.1</b> Tips</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="model-fitting.html"><a href="model-fitting.html#stan-stuff"><i class="fa fa-check"></i><b>1.2</b> Stan Stuff</a><ul>
<li class="chapter" data-level="1.2.1" data-path="model-fitting.html"><a href="model-fitting.html#tips-1"><i class="fa fa-check"></i><b>1.2.1</b> Tips</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="model-fitting.html"><a href="model-fitting.html#priors"><i class="fa fa-check"></i><b>1.3</b> Priors</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="rstanreg-r.html"><a href="rstanreg-r.html"><i class="fa fa-check"></i><b>2</b> <code>R/stanreg.R</code></a></li>
<li class="chapter" data-level="3" data-path="methods.html"><a href="methods.html"><i class="fa fa-check"></i><b>3</b> Methods</a><ul>
<li class="chapter" data-level="3.1" data-path="methods.html"><a href="methods.html#predict"><i class="fa fa-check"></i><b>3.1</b> <code>predict</code></a></li>
<li class="chapter" data-level="3.2" data-path="methods.html"><a href="methods.html#posterior_predict"><i class="fa fa-check"></i><b>3.2</b> <code>posterior_predict</code></a></li>
<li class="chapter" data-level="3.3" data-path="methods.html"><a href="methods.html#posterior_linpred"><i class="fa fa-check"></i><b>3.3</b> <code>posterior_linpred</code></a></li>
<li class="chapter" data-level="3.4" data-path="methods.html"><a href="methods.html#loo-and-log_lik"><i class="fa fa-check"></i><b>3.4</b> <code>loo</code> and <code>log_lik</code></a><ul>
<li class="chapter" data-level="3.4.1" data-path="methods.html"><a href="methods.html#llfun"><i class="fa fa-check"></i><b>3.4.1</b> <code>llfun</code></a></li>
<li class="chapter" data-level="3.4.2" data-path="methods.html"><a href="methods.html#llargs"><i class="fa fa-check"></i><b>3.4.2</b> <code>llargs</code></a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="methods.html"><a href="methods.html#prior_summary"><i class="fa fa-check"></i><b>3.5</b> <code>prior_summary</code></a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="documentation-and-examples.html"><a href="documentation-and-examples.html"><i class="fa fa-check"></i><b>4</b> Documentation and Examples</a></li>
<li class="chapter" data-level="5" data-path="testing.html"><a href="testing.html"><i class="fa fa-check"></i><b>5</b> Testing</a></li>
<li class="chapter" data-level="6" data-path="vignettes.html"><a href="vignettes.html"><i class="fa fa-check"></i><b>6</b> Vignettes</a></li>
<li class="chapter" data-level="7" data-path="an-outline-of-what-goes-where.html"><a href="an-outline-of-what-goes-where.html"><i class="fa fa-check"></i><b>7</b> An outline of what goes where</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Rstanarm Developer Notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="methods" class="section level1">
<h1><span class="header-section-number">3</span> Methods</h1>
<p>Most of the <code>*.stanreg</code> methods are in <code>R/stanreg-methods.R</code>, but as long as things are done appropriately in the .fit file and in <code>stanreg.R</code> all the methods here should work fine.</p>
<div id="predict" class="section level2">
<h2><span class="header-section-number">3.1</span> <code>predict</code></h2>
<p>The main thing here is to make sure predict works appropriately when the user declares new data. As a rough check, the predictions should match the predictions made by the function you’re emulating.</p>
<p>Also, if no new data is declared then <code>predict(fit)</code> and <code>fit$fitted.values</code> should be identical.</p>
</div>
<div id="posterior_predict" class="section level2">
<h2><span class="header-section-number">3.2</span> <code>posterior_predict</code></h2>
<p>This is a little more involved than the <code>predict</code> method. Essentially you need to return and <span class="math inline">\(N \times S\)</span> dimensional matrix where <span class="math inline">\(N\)</span> is the number of observations and <span class="math inline">\(S\)</span> is the number of draws from the posterior distribution. There are two parts to this:</p>
<ol style="list-style-type: decimal">
<li>Specify <code>pp_fun</code></li>
</ol>
<ul>
<li><code>pp_fun</code> will call on the posterior prediction function of the form <code>.pp_*</code>. So you need to specify the (stochastic) data generating process within <code>.pp_*</code>. We use <code>sapply()</code> to iterate over the number of draws and compute the fitted values.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Specify <code>pp_args</code></li>
</ol>
<ul>
<li>Include anything you might need for posterior predictions within the <code>args</code> list in the <code>pp_args</code> function. (Make sure you do any necessary link function transformations here.)</li>
</ul>
</div>
<div id="posterior_linpred" class="section level2">
<h2><span class="header-section-number">3.3</span> <code>posterior_linpred</code></h2>
</div>
<div id="loo-and-log_lik" class="section level2">
<h2><span class="header-section-number">3.4</span> <code>loo</code> and <code>log_lik</code></h2>
<p>You need to check whether,</p>
<ol style="list-style-type: decimal">
<li><code>loo()</code> is using the correct log likelihood specified in <code>log_lik.R</code>. This is the log likelihood function that corresponds to <code>object$family</code> (or some other identifier that you can subset from <code>object</code>). If it does then you’re done.</li>
<li>If not then you need to specify the appropriate log likelihood to be used in <code>loo()</code>.</li>
</ol>
<p>Getting the loo function to work on a stanreg object can be tricky. It involves creating a log likelihood function for the posterior <code>llfun</code> and a set of arguments to be passed through this function <code>llargs</code>.</p>
<div id="llfun" class="section level3">
<h3><span class="header-section-number">3.4.1</span> <code>llfun</code></h3>
<p>The best way to think about this is that you want to create a <span class="math inline">\(S \times N\)</span> matrix point-wise log likelihood, where <span class="math inline">\(S\)</span> is the number of draws and <span class="math inline">\(N\)</span> is the number of observations (i.e. you’re evaluating the log-likelihood of the posterior for each datum and draw from the marginal posterior).</p>
<p>The approach taken with using loo on a stanreg object is to declare a function that iterates over the data, rather than specifying the entire point-wise log likelihood matrix.</p>
</div>
<div id="llargs" class="section level3">
<h3><span class="header-section-number">3.4.2</span> <code>llargs</code></h3>
<p>Within the <code>llargs</code> list <code>data</code> needs to be a data frame or matrix that can be iterated over <span class="math inline">\(N\)</span> times. <code>draws</code> should be a list containing the draws of <span class="math inline">\(S\)</span> dimension. One way to think about it is that data is what you need to iterate over and draws is fixed. <del>This is useful in cases where some variables may be considered as data but you don’t actually want to iterate over them, or in cases where you only have one observation and actually need to iterate over the draws (e.g. a multinormal outcome with correlated errors.)</del></p>
</div>
</div>
<div id="prior_summary" class="section level2">
<h2><span class="header-section-number">3.5</span> <code>prior_summary</code></h2>
<p>The <code>prior_summary</code> function is used to report the prior distributions specified on the parameters when the sampler iterates over the target distribution (which is not necessarily identical to what the user declares).</p>
<ol style="list-style-type: decimal">
<li>Define a <code>summarize_*_prior</code> function at the end of the model’s .fit file to capture all the prior information. See <code>stan_glm.fit</code> for a comprehensive example or <code>stan_sp.fit</code> for a simple example.
<ul>
<li>If the user can call <code>prior_aux</code> then you need to give this parameter a name in <code>$prior_aux$aux_name = &quot;prior_aux_name_here&quot;</code>. (e.g. in spatial models we have <code>$prior_aux$aux_name = &quot;rho&quot;</code> and in stan_betareg we have <code>$prior_aux$aux_name = &quot;phi&quot;</code>)</li>
</ul></li>
<li>Call <code>prior_info &lt;- summarize_*_prior(...)</code> before you do any model fitting.</li>
<li>At end of the <code>&quot;optimizing&quot;</code> and <code>&quot;sampling&quot;</code> conditionals make sure you <code>return(structure(stanfit, prior.info = prior_info))</code>.</li>
</ol>
<p>If you do this right then everything should work out swimmingly in the <code>prior_summary.R</code> file. If it so happens that you’ve introduced a new prior then you’ll need to update the conditional in the relevant <code>.prior_*_prior</code> function to pick this information up.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="rstanreg-r.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="documentation-and-examples.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
