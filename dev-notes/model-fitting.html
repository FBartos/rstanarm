<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Rstanarm Developer Notes</title>
  <meta name="description" content="Rstanarm Developer Notes">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="Rstanarm Developer Notes" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://mc-stan.org/rstanarm/index.html" />
  <meta property="og:image" content="https://mc-stan.org/rstanarm/index.htmlimages/logo.png" />
  
  <meta name="github-repo" content="stan-dev/rstanarm" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Rstanarm Developer Notes" />
  
  
  <meta name="twitter:image" content="https://mc-stan.org/rstanarm/index.htmlimages/logo.png" />

<meta name="author" content="Stan Development Team">


<meta name="date" content="2017-06-16">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  <link rel="shortcut icon" href="images/logo-icon.png" type="image/x-icon">
<link rel="prev" href="index.html">
<link rel="next" href="rstanreg-r.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />










<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Rstanarm Developer Notes</a></li>
<li class="chapter" data-level="1" data-path="model-fitting.html"><a href="model-fitting.html"><i class="fa fa-check"></i><b>1</b> Model Fitting</a><ul>
<li class="chapter" data-level="1.1" data-path="model-fitting.html"><a href="model-fitting.html#r-stuff"><i class="fa fa-check"></i><b>1.1</b> R Stuff</a><ul>
<li class="chapter" data-level="1.1.1" data-path="model-fitting.html"><a href="model-fitting.html#tips"><i class="fa fa-check"></i><b>1.1.1</b> Tips</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="model-fitting.html"><a href="model-fitting.html#stan-stuff"><i class="fa fa-check"></i><b>1.2</b> Stan Stuff</a><ul>
<li class="chapter" data-level="1.2.1" data-path="model-fitting.html"><a href="model-fitting.html#tips-1"><i class="fa fa-check"></i><b>1.2.1</b> Tips</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="model-fitting.html"><a href="model-fitting.html#priors"><i class="fa fa-check"></i><b>1.3</b> Priors</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="rstanreg-r.html"><a href="rstanreg-r.html"><i class="fa fa-check"></i><b>2</b> <code>R/stanreg.R</code></a></li>
<li class="chapter" data-level="3" data-path="methods.html"><a href="methods.html"><i class="fa fa-check"></i><b>3</b> Methods</a><ul>
<li class="chapter" data-level="3.1" data-path="methods.html"><a href="methods.html#predict"><i class="fa fa-check"></i><b>3.1</b> <code>predict</code></a></li>
<li class="chapter" data-level="3.2" data-path="methods.html"><a href="methods.html#posterior_predict"><i class="fa fa-check"></i><b>3.2</b> <code>posterior_predict</code></a></li>
<li class="chapter" data-level="3.3" data-path="methods.html"><a href="methods.html#posterior_linpred"><i class="fa fa-check"></i><b>3.3</b> <code>posterior_linpred</code></a></li>
<li class="chapter" data-level="3.4" data-path="methods.html"><a href="methods.html#loo-and-log_lik"><i class="fa fa-check"></i><b>3.4</b> <code>loo</code> and <code>log_lik</code></a><ul>
<li class="chapter" data-level="3.4.1" data-path="methods.html"><a href="methods.html#llfun"><i class="fa fa-check"></i><b>3.4.1</b> <code>llfun</code></a></li>
<li class="chapter" data-level="3.4.2" data-path="methods.html"><a href="methods.html#llargs"><i class="fa fa-check"></i><b>3.4.2</b> <code>llargs</code></a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="methods.html"><a href="methods.html#prior_summary"><i class="fa fa-check"></i><b>3.5</b> <code>prior_summary</code></a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="documentation-and-examples.html"><a href="documentation-and-examples.html"><i class="fa fa-check"></i><b>4</b> Documentation and Examples</a></li>
<li class="chapter" data-level="5" data-path="testing.html"><a href="testing.html"><i class="fa fa-check"></i><b>5</b> Testing</a></li>
<li class="chapter" data-level="6" data-path="vignettes.html"><a href="vignettes.html"><i class="fa fa-check"></i><b>6</b> Vignettes</a></li>
<li class="chapter" data-level="7" data-path="an-outline-of-what-goes-where.html"><a href="an-outline-of-what-goes-where.html"><i class="fa fa-check"></i><b>7</b> An outline of what goes where</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Rstanarm Developer Notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="model-fitting" class="section level1">
<h1><span class="header-section-number">1</span> Model Fitting</h1>
<p>Below we break things down into stuff you need to do in R and stuff you need to do in Stan to get the model working.</p>
<div id="r-stuff" class="section level2">
<h2><span class="header-section-number">1.1</span> R Stuff</h2>
<p>First add the package you plan on emulating in the <code>DESCRIPTION</code> file under <code>suggests:</code>.</p>
<p>You’ll need to write an rstanarm function for each of the models you plan on emulating. These functions should call a .fit workhorse function which will run Stan. Essentially, the workflow will look something like the following:</p>
<pre><code>┏━━━━━━ USER ━━━━━━┓
model_A.R                  model_B.R
┗━━━━ model.fit ━━━━┛
┃
model.stan</code></pre>
<p>Regarding the above diagram, the <code>model_*.R</code> and <code>model.fit</code> files are in the <code>R</code> folder and the <code>model.stan</code> file is in the <code>exec</code> folder. You should include existing snippets of stan code in your <code>model.stan</code> file. These are located in the <code>inst/chunks</code> folder.</p>
<p>In the .fit function you should,</p>
<ul>
<li>Center the covariates (if there is an intercept).</li>
<li>Perform QR decomposition.</li>
<li>Determine whether the intercept is declared (or whether multiple linear predictors have been declared).</li>
<li>Extract and process information regarding the priors declared.</li>
<li>Define the parameters that you want Stan to return as a vector of strings <code>pars</code>.</li>
<li>Put together data as a list that can be called into rstan.</li>
</ul>
<p>Conditionals should be set up so that the .fit workhorse function can deal with the following algorithm arguments.</p>
<ul>
<li><code>'optimizing'</code></li>
<li><code>'sampling'</code></li>
<li><code>'fullrank'</code> and <code>'meanfield'</code> (Variational Bayes methods)</li>
</ul>
<div id="tips" class="section level3">
<h3><span class="header-section-number">1.1.1</span> Tips</h3>
<ul>
<li>If you added a new argument to your modeling function and are wondering why the argument is not recognized when you run the function (after building the package) it’s probably because you haven’t NULLified the argument in the <code>match.call(expand.dots = FALSE)</code> list.</li>
<li>If Stan isn’t returning parameters that are in the model make sure you’ve specified them in <code>pars</code>.</li>
<li>If the model’s family is using an existing family but the model linear predictor, etc. is different then it might be a good idea to give it an additional class identifier: <code>class(out) &lt;- c(&quot;stanreg&quot;, &quot;additional_class&quot;)</code></li>
</ul>
</div>
</div>
<div id="stan-stuff" class="section level2">
<h2><span class="header-section-number">1.2</span> Stan Stuff</h2>
<p>In the Stan file you should try to minimize the number of loops, storing n-dimensional objects, redoing calculations that only need to be done once, calculating inverses (e.g. use the precision multinormal instead of multinormal).</p>
<p>Because we center the covariates when there is an intercept, you have to separate the intercept out of the linear predictor matrix (i.e. <code>X</code> should not contain a vector of ones). If <code>gamma</code> is the intercept parameter fit using centered predictors and <code>alpha</code> is the intercept parameter you want to report then do the following transformation in generated quantities: <code>... generated quantities {   real alpha[has_intercept];   if (has_intercept) {     alpha[1] = gamma[1] - dot_product(beta, xbar)   } }</code></p>
<p>Don’t forget to evaluate <code>mean_PPD</code> (the mean of the posterior predictive distribution) in the generated quantities block.</p>
<p>For efficiency posterior predictions and the log likelihood is computed in R.</p>
<div id="tips-1" class="section level3">
<h3><span class="header-section-number">1.2.1</span> Tips</h3>
<ul>
<li><strong>Every time you make a change to a Stan file you need to recompile the package</strong>. (Only running <code>devtools::build()</code> is not sufficient.) So do the following:<br />
</li>
</ul>
<ol style="list-style-type: decimal">
<li>Move one level up from the <code>rstanarm/</code> directory.</li>
<li>From the command line run <code>R CMD INSTALL --preclean rstanarm</code>.</li>
<li>In RStudio run <code>devtools::build()</code>.</li>
</ol>
<ul>
<li>In the generated quantities block define the variables you want to report globally and use local scopes (i.e. <code>{}</code>) to define (and perform calculations on) N-dimensional objects.</li>
</ul>
</div>
</div>
<div id="priors" class="section level2">
<h2><span class="header-section-number">1.3</span> Priors</h2>
<p>This varies from model to model.</p>
<p>In the Stan file you should be able to use existing code in <code>inst/chunks</code> to apply priors on the intercept (if it exists) and independent priors on the parameters of the predictors.</p>
<p>User <code>prior_aux</code> to take care of single scalar parameters in the model (e.g. the spatial autocorrelation coefficient in spatial models)</p>
<p>If you need the user to define a prior distribution that is not currently available then add the function in <code>R/priors.R</code>. (Use the existing functions as a guide). Include the appropriate documentation so that prior distribution is defined in the <code>?priors</code> help page.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="rstanreg-r.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
