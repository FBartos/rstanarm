<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>K-fold cross-validation — kfold.stanreg • rstanarm</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="K-fold cross-validation — kfold.stanreg" />
<meta property="og:description" content="The kfold method performs exact \(K\)-fold cross-validation. First
the data are randomly partitioned into \(K\) subsets of equal size (or as close
to equal as possible), or the user can specify the folds argument
to determine the partitioning. Then the model is refit \(K\) times, each time
leaving out one of the \(K\) subsets. If \(K\) is equal to the total
number of observations in the data then \(K\)-fold cross-validation is
equivalent to exact leave-one-out cross-validation (to which
loo is an efficient approximation)." />
<meta property="og:image" content="https://mc-stan.org/rstanarm/logo.png" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rstanarm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.21.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="../dev-notes/index.html">Develop</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="https://mc-stan.org/rstan">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr">cmdstanr</a>
    </li>
    <li>
      <a href="https://mc-stan.org/bayesplot">bayesplot</a>
    </li>
    <li>
      <a href="https://mc-stan.org/shinystan">shinystan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/loo">loo</a>
    </li>
    <li>
      <a href="https://mc-stan.org/projpred">projpred</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstantools">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://mc-stan.org">Stan</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://twitter.com/mcmc_stan">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/rstanarm">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://discourse.mc-stan.org/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>K-fold cross-validation</h1>
    <small class="dont-index">Source: <a href='https://github.com/stan-dev/rstanarm/blob/master/R/loo-kfold.R'><code>R/loo-kfold.R</code></a></small>
    <div class="hidden name"><code>kfold.stanreg.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>The <code>kfold</code> method performs exact \(K\)-fold cross-validation. First
the data are randomly partitioned into \(K\) subsets of equal size (or as close
to equal as possible), or the user can specify the <code>folds</code> argument
to determine the partitioning. Then the model is refit \(K\) times, each time
leaving out one of the \(K\) subsets. If \(K\) is equal to the total
number of observations in the data then \(K\)-fold cross-validation is
equivalent to exact leave-one-out cross-validation (to which
<code><a href='loo.stanreg.html'>loo</a></code> is an efficient approximation).</p>
    </div>

    <pre class="usage"><span class='co'># S3 method for stanreg</span>
<span class='fu'>kfold</span>(
  <span class='no'>x</span>,
  <span class='kw'>K</span> <span class='kw'>=</span> <span class='fl'>10</span>,
  <span class='no'>...</span>,
  <span class='kw'>folds</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>save_fits</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>cores</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/options.html'>getOption</a></span>(<span class='st'>"mc.cores"</span>, <span class='fl'>1</span>)
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>x</th>
      <td><p>A fitted model object returned by one of the rstanarm modeling
functions. See <a href='stanreg-objects.html'>stanreg-objects</a>.</p></td>
    </tr>
    <tr>
      <th>K</th>
      <td><p>For <code>kfold</code>, the number of subsets (folds) into which the data
will be partitioned for performing \(K\)-fold cross-validation. The model
is refit <code>K</code> times, each time leaving out one of the <code>K</code> folds.
If the <code>folds</code> argument is specified then <code>K</code> will automatically
be set to <code><a href='https://rdrr.io/r/base/length.html'>length(unique(folds))</a></code>, otherwise the specified value of
<code>K</code> is passed to <code>loo::<a href='https://mc-stan.org/loo/reference/kfold-helpers.html'>kfold_split_random</a></code> to
randomly partition the data into <code>K</code> subsets of equal (or as close to
equal as possible) size.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Currently ignored.</p></td>
    </tr>
    <tr>
      <th>folds</th>
      <td><p>For <code>kfold</code>, an optional integer vector with one element
per observation in the data used to fit the model. Each element of the
vector is an integer in <code>1:K</code> indicating to which of the <code>K</code>
folds the corresponding observation belongs. There are some convenience
functions available in the <span class="pkg">loo</span> package that create integer vectors to
use for this purpose (see the <strong>Examples</strong> section below and also the
<a href='https://mc-stan.org/loo/reference/kfold-helpers.html'>kfold-helpers</a> page).</p></td>
    </tr>
    <tr>
      <th>save_fits</th>
      <td><p>For <code>kfold</code>, if <code>TRUE</code>, a component <code>'fits'</code>
is added to the returned object to store the cross-validated
<a href='stanreg-objects.html'>stanreg</a> objects and the indices of the omitted
observations for each fold. Defaults to <code>FALSE</code>.</p></td>
    </tr>
    <tr>
      <th>cores</th>
      <td><p>The number of cores to use for parallelization. Instead fitting
separate Markov chains for the same model on different cores, by default
<code>kfold</code> will distribute the <code>K</code> models to be fit across the cores
(using <code><a href='https://rdrr.io/r/parallel/clusterApply.html'>parLapply</a></code> on Windows and
<code><a href='https://rdrr.io/r/parallel/mclapply.html'>mclapply</a></code> otherwise). The Markov chains for each
model will be run sequentially. This will often be the most efficient
option, especially if many cores are available, but in some cases it may be
preferable to fit the <code>K</code> models sequentially and instead use the
cores for the Markov chains. This can be accomplished by setting
<code><a href='https://rdrr.io/r/base/options.html'>options(mc.cores)</a></code> to be the desired number of cores to use
for the Markov chains <em>and</em> also manually specifying <code>cores=1</code>
when calling the <code>kfold</code> function. See the end of the
<strong>Examples</strong> section for a demonstration.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>An object with classes 'kfold' and 'loo' that has a similar structure
  as the objects returned by the <code><a href='loo.stanreg.html'>loo</a></code> and <code><a href='loo.stanreg.html'>waic</a></code>
  methods and is compatible with the <code><a href='loo.stanreg.html'>loo_compare</a></code> function for
  comparing models.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical
  Bayesian model evaluation using leave-one-out cross-validation and WAIC.
  <em>Statistics and Computing</em>. 27(5), 1413--1432.
  doi:10.1007/s11222-016-9696-4. arXiv preprint:
  <a href='http://arxiv.org/abs/1507.04544/'>http://arxiv.org/abs/1507.04544/</a></p>
<p>Yao, Y., Vehtari, A., Simpson, D., and Gelman, A. (2018) Using
  stacking to average Bayesian predictive distributions. <em>Bayesian
  Analysis</em>, advance publication,  doi:10.1214/17-BA1091.
  (<a href='https://projecteuclid.org/euclid.ba/1516093227'>online</a>).</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># \donttest{</span>
<span class='no'>fit1</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='stan_glm.html'>stan_glm</a></span>(<span class='no'>mpg</span> ~ <span class='no'>wt</span>, <span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>mtcars</span>, <span class='kw'>refresh</span> <span class='kw'>=</span> <span class='fl'>0</span>)
<span class='no'>fit2</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='stan_glm.html'>stan_glm</a></span>(<span class='no'>mpg</span> ~ <span class='no'>wt</span> + <span class='no'>cyl</span>, <span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>mtcars</span>, <span class='kw'>refresh</span> <span class='kw'>=</span> <span class='fl'>0</span>)
<span class='no'>fit3</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='stan_glm.html'>stan_glm</a></span>(<span class='no'>mpg</span> ~ <span class='no'>disp</span> * <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span>(<span class='no'>cyl</span>), <span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>mtcars</span>, <span class='kw'>refresh</span> <span class='kw'>=</span> <span class='fl'>0</span>)

<span class='co'># 10-fold cross-validation</span>
<span class='co'># (if possible also specify the 'cores' argument to use multiple cores)</span>
(<span class='no'>kfold1</span> <span class='kw'>&lt;-</span> <span class='fu'>kfold</span>(<span class='no'>fit1</span>, <span class='kw'>K</span> <span class='kw'>=</span> <span class='fl'>10</span>))</div><div class='output co'>#&gt; <span class='message'>Fitting model 1 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 2 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 3 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 4 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 5 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 6 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 7 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 8 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 9 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 10 out of 10</span></div><div class='output co'>#&gt; 
#&gt; Based on 10-fold cross-validation
#&gt; 
#&gt;            Estimate  SE
#&gt; elpd_kfold    -83.6 4.2
#&gt; p_kfold          NA  NA
#&gt; kfoldic       167.2 8.5</div><div class='input'><span class='no'>kfold2</span> <span class='kw'>&lt;-</span> <span class='fu'>kfold</span>(<span class='no'>fit2</span>, <span class='kw'>K</span> <span class='kw'>=</span> <span class='fl'>10</span>)</div><div class='output co'>#&gt; <span class='message'>Fitting model 1 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 2 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 3 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 4 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 5 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 6 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 7 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 8 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 9 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 10 out of 10</span></div><div class='input'><span class='no'>kfold3</span> <span class='kw'>&lt;-</span> <span class='fu'>kfold</span>(<span class='no'>fit3</span>, <span class='kw'>K</span> <span class='kw'>=</span> <span class='fl'>10</span>)</div><div class='output co'>#&gt; <span class='message'>Fitting model 1 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 2 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 3 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 4 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 5 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 6 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 7 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 8 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 9 out of 10</span></div><div class='output co'>#&gt; <span class='message'>Fitting model 10 out of 10</span></div><div class='input'><span class='fu'><a href='loo.stanreg.html'>loo_compare</a></span>(<span class='no'>kfold1</span>, <span class='no'>kfold2</span>, <span class='no'>kfold3</span>)</div><div class='output co'>#&gt;      elpd_diff se_diff
#&gt; fit3  0.0       0.0   
#&gt; fit2 -4.6       6.1   
#&gt; fit1 -6.0       5.0   </div><div class='input'>
<span class='co'># stratifying by a grouping variable</span>
<span class='co'># (note: might get some divergences warnings with this model but </span>
<span class='co'># this is just intended as a quick example of how to code this)</span>
<span class='no'>fit4</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='stan_glmer.html'>stan_lmer</a></span>(<span class='no'>mpg</span> ~ <span class='no'>disp</span> + (<span class='fl'>1</span><span class='kw'>|</span><span class='no'>cyl</span>), <span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>mtcars</span>, <span class='kw'>refresh</span> <span class='kw'>=</span> <span class='fl'>0</span>)</div><div class='output co'>#&gt; <span class='warning'>Warning: There were 5 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See</span>
#&gt; <span class='warning'>http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></div><div class='output co'>#&gt; <span class='warning'>Warning: Examine the pairs() plot to diagnose sampling problems</span></div><div class='input'><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span>(<span class='no'>mtcars</span>$<span class='no'>cyl</span>)</div><div class='output co'>#&gt; 
#&gt;  4  6  8 
#&gt; 11  7 14 </div><div class='input'><span class='no'>folds_cyl</span> <span class='kw'>&lt;-</span> <span class='kw pkg'>loo</span><span class='kw ns'>::</span><span class='fu'><a href='https://mc-stan.org/loo/reference/kfold-helpers.html'>kfold_split_stratified</a></span>(<span class='kw'>K</span> <span class='kw'>=</span> <span class='fl'>3</span>, <span class='kw'>x</span> <span class='kw'>=</span> <span class='no'>mtcars</span>$<span class='no'>cyl</span>)
<span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span>(<span class='kw'>cyl</span> <span class='kw'>=</span> <span class='no'>mtcars</span>$<span class='no'>cyl</span>, <span class='kw'>fold</span> <span class='kw'>=</span> <span class='no'>folds_cyl</span>)</div><div class='output co'>#&gt;    fold
#&gt; cyl 1 2 3
#&gt;   4 4 4 3
#&gt;   6 2 2 3
#&gt;   8 5 5 4</div><div class='input'><span class='no'>kfold4</span> <span class='kw'>&lt;-</span> <span class='fu'>kfold</span>(<span class='no'>fit4</span>, <span class='kw'>folds</span> <span class='kw'>=</span> <span class='no'>folds_cyl</span>, <span class='kw'>cores</span> <span class='kw'>=</span> <span class='fl'>2</span>)</div><div class='output co'>#&gt; <span class='message'>Fitting K = 3 models distributed over 2 cores</span></div><div class='input'><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span>(<span class='no'>kfold4</span>)</div><div class='output co'>#&gt; 
#&gt; Based on 3-fold cross-validation
#&gt; 
#&gt;            Estimate  SE
#&gt; elpd_kfold    -86.4 4.2
#&gt; p_kfold          NA  NA
#&gt; kfoldic       172.7 8.5</div><div class='input'># }

# Example code demonstrating the different ways to specify the number 
# of cores and how the cores are used
# 
# options(mc.cores = NULL)
# 
# # spread the K models over N_CORES cores (method 1)
# kfold(fit, K, cores = N_CORES)
# 
# # spread the K models over N_CORES cores (method 2)
# options(mc.cores = N_CORES)
# kfold(fit, K)
#  
# # fit K models sequentially using N_CORES cores for the Markov chains each time
# options(mc.cores = N_CORES)
# kfold(fit, K, cores = 1)

</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Jonah Gabry, Ben Goodrich.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


